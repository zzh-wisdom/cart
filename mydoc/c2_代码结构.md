# Cart 代码结构

## opcode

RPC由opcode唯一标识，opcode是一个32bit位的整数。

cart中的RPC按照proto(编码？)来分类管理的，每种proto包含若干个特定于具体rpc的proto方法。

opcode的编码如下：

|0-----------------------------15|16--23|24-----31|

| 特定于所在proto类别的序号 |  版本   | base |

其中base可以理解为protoc的类别号。

其中最高16bit位全为1是预留给cart内部使用的，内部会注册一个叫`internal-proto`的protoc类别，该类别包含许多内部使用的rpc。

### opcode的管理

opcode是通过一个三维数组的map来管理的。

1. 第一维数组使用base，即种类号（opcode的最高8位）作为索引下标
2. 第二维数组使用版本号，即接下来的8个bit位作为索引下标
3. 第三维数组使用特定于proto种类的序号（cpf_count），即opcode的最低16个bit位作为索引下标，**实际为cpf_count-1**

一个opcode的信息由一个类型为`crt_opc_info`的结构体实例管理。即第三维数组的元素类型为`crt_opc_info`。

## cache

lc, local cache, lookup cache,

Lookup the URI and NA address of a (rank, tag) combination in the addr cache.

**共享全局na类，则tag=0**

rank：主要组的rank

grp_priv->gp_lookup_cache[ctx_idx]

数组，每个元素为一个table，下标为ctx_idx。对于一个table，key为rank。

对于每个rank对应的信息（table的value信息），包含tag->(hg_addr, uri)的映射，实际是使用两个数组来实现的。

uri就是物理地址crt_phy_addr_t



## 注意要点

1. RPC is identified by opcode.
2. 小信息和bulk传输的分界线：64M，大于64M则使用bulk传输。

